<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Satoshi:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0&display=swap" />
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-[#161616]">
    <div class="flex flex-row md:flex-row">
        {% include 'sidebar.html' %}
        <div class="flex-grow p-4 w-full">
            <div class="text-[#f2f2f2] font-bold text-2xl">
                <h1>Nosos Tracking Dashboard</h1>
            </div>

            <!-- WEATHER INFORMATION AND PIE CHART -->
            <div class="flex flex-row md:flex-row gap-4 mt-2">
                <!-- Weather Information Box -->
                <div class= "flex flex-col bg-[#252525] w-full md:w-1/6 h-auto rounded-2xl text-[#f2f2f2] px-3 py-2">
                    
                    <div class="flex flex-col justify-between items-start px-1">
                        <img src="{{ url_for('static', filename='images/Weather.png') }}" class="bg-[#252525] w-20 h-20 object-contain" alt="Weather">
                        <div class="text-center mb-4">
                            <h2 class="font-normal text-lg md:text-4xl">28Â°</h2>
                            <h5 class="font-light text-sm">Temperature</h5>
                        </div>
                        <div class="text-center md:text-left mb-6">
                            <h2 class="font-bold text-lg md:text-2xl">Philippines</h2>
                            <h5 class="font-normal text-sm md:text-base">Davao City</h5>
                        </div>
                        <h2 class="font-bold text-sm md:text-base">20 November, 2024</h2>
                    <h5 class="font-light text-xs md:text-sm">Wednesday</h5>
                    </div>
                </div>
                <!-- Disease Information Pie Chart -->
                <div class="w-full md:w-2/5 mt-4 md:mt-0 flex flex-col items-center">
                    <div class="w-full mt-4 md:mt-0 flex flex-col items-start bg-[#252525] h-auto rounded-2xl text-[#f2f2f2] px-6 py-2">
                        <h2 class="font-semibold ">Climatic Factors by Historical Data of Diseases</h2>
                        <div class="relative inline-block mt-2">
                            <!-- Dropdown Button -->
                            <span id="dropdownButton" class="material-symbols-outlined bg-[#3E3E3E] text-[#f2f2f2] rounded-xl gap-4 px-5 py-1 cursor-pointer flex items-center justify-between">
                                <span id="dropdownSelectedValue" class="text-sm font-sans font-medium mb-0.5">Dengue</span>
                                <span class="material-symbols-outlined">arrow_drop_down</span>
                            </span>
                        
                            <!-- Dropdown Menu -->
                            <div id="dropdownMenu" class="absolute bg-[#3E3E3E] text-[#f2f2f2] rounded-lg mt-2 p-2 hidden z-10">
                                <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="DENGUE FEVER">Dengue</div>
                                <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="ACUTE BLOODY DIARRHEA">AB Diarrhea</div>
                                <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="TYPHOID FEVER">Typhoid</div>
                                <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="LEPTOSPIROSIS">Leptospirosis</div>
                            </div>
                        </div>
                        
                        <div class="flex flex-row-reverse justify-between items-center w-full gap-4">
                            <canvas id="pieChart" class="size-56 mr-20 mb-6"></canvas>
                            <div class="flex flex-col gap-3 text-[#f2f2f2] font-medium text-xs">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#023e8a] inline-block rounded-full"></span>
                                    <span>Average Temperature</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#c1121f] inline-block rounded-full"></span>
                                    <span>Min Temperature</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#3a5a40] inline-block rounded-full"></span>
                                    <span>Max Temperature</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#8338ec] inline-block rounded-full"></span>
                                    <span>Heat Index</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#6a040f] inline-block rounded-full"></span>
                                    <span>Precipitation</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#240046] inline-block rounded-full"></span>
                                    <span>Wind Speed</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#33658a] inline-block rounded-full"></span>
                                    <span>Humidity</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#0d21a1] inline-block rounded-full"></span>
                                    <span>Solar Radiation</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-4 bg-[#d90368] inline-block rounded-full"></span>
                                    <span>UV Radiation</span>
                                </div>
                            </div>
                        </div>
                    </div>                 
                </div>
                <div class="w-full md:w-2/5 relative">
                    <div class="bg-[#252525] w-full h-auto rounded-2xl text-[#f2f2f2] px-6 py-4 relative">
                        <div class="flex flex-col relative">
                            <h2 class="font-semibold">Predicted Cases by Top Cities</h2>
                
                            <!-- Week Selection Dropdown -->
                            <div class="relative inline-block mt-2">
                                <span id="dropdownButtonWeeks" class="material-symbols-outlined bg-[#3E3E3E] text-[#f2f2f2] rounded-xl gap-4 px-5 py-1 cursor-pointer flex items-center justify-between">
                                    <span id="dropdownSelectedValueWeeks" class="text-sm font-sans font-medium mb-0.5">All Weeks</span>
                                    <span class="material-symbols-outlined">arrow_drop_down</span>
                                </span>
                
                                <!-- Dropdown Menu -->
                                <div id="dropdownMenuWeeks" class="absolute bg-[#3E3E3E] text-[#f2f2f2] rounded-lg mt-2 p-2 hidden z-10">
                                    <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="all">All Weeks</div>
                                    <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="1">Week 1</div>
                                    <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="2">Week 2</div>
                                    <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="3">Week 3</div>
                                    <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="4">Week 4</div>
                                    <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="5">Week 5</div>
                                </div>
                            </div>
                
                            <canvas id="barChart" class="w-full h-60 mt-4"></canvas>
                        </div>
                    </div>
                </div>
                
                
            </div>

            <!-- DISEASE INFORMATION -->
            <div class="flex flex-row gap-4">
                <div class="bg-[#252525] w-full md:w-7/12 h-auto rounded-2xl text-[#f2f2f2] px-6 py-4 mt-3">
                    <div class="flex flex-wrap gap-4">
                        <!-- Disease Risk Level Section -->
                        <div class="rounded-lg w-full md:w-1/2 h-auto flex-1 text-center p-4 relative bg-gradient-to-bl from-[rgba(255,102,102,0.3)] from-0% to-[rgba(62,62,62,0.3)] to-65%">
                            <span class="material-symbols-outlined bg-[#252525] rounded-full text-lg size-8 absolute top-2 left-2">warning</span>
                            <div class="mt-10">
                                <h2 class="font-semibold text-base">Disease Risk Level</h2>
                                <ol class="flex flex-row items-end justify-center gap-6 mt-12">
                                    <li class="flex flex-col items-center"><span class="bg-[#28A745] w-4 h-10 rounded-lg mb-2 opacity-75"></span><h5 class="text-xs font-semibold">Low</h5></li>
                                    <li class="flex flex-col items-center"><span class="bg-[#FFC107] w-4 h-14 rounded-lg mb-2 opacity-75"></span><h5 class="text-xs font-semibold">Medium</h5></li>
                                    <li class="flex flex-col items-center"><span class="bg-[#FD7E14] w-4 h-20 rounded-lg mb-2 opacity-75"></span><h5 class="text-xs font-semibold">High</h5></li>
                                    <li class="flex flex-col items-center"><span class="bg-[#DC3545] w-4 h-28 rounded-lg mb-2 opacity-75"></span><h5 class="text-xs font-semibold">Severe</h5></li>
                                </ol>
                            </div>
                        </div>
    
                        <!-- Total Number of Predicted Cases -->
                        <div class="rounded-lg w-full md:w-1/2 h-auto flex-1 text-center p-4 relative bg-gradient-to-bl from-[rgba(102,102,255,0.3)] from-0% to-[rgba(62,62,62,0.3)] to-65%">
                            <span class="material-symbols-outlined bg-[#252525] rounded-full text-lg size-8 absolute top-2 left-2 p-0.5">trending_up</span>
                            <div class="mt-10">
                                <h2 class="font-semibold text-sm">Total Number of Predicted Cases for Each City</h2>
                                <h2 id="totalCases" class="mt-10 text-6xl font-thin">
                                    {% if city_totals %}
                                        Select a City
                                    {% else %}
                                        No Data Available
                                    {% endif %}
                                </h2>
                                <h5 class="text-xs mt-12">
                                    Predicted 
                                    <span class="font-bold" id="diseaseName">{{ session.get('selected_disease', 'Disease').title() }}</span> 
                                    cases in 
                                    <span class="font-bold" id="selectedCity">N/A</span>
                                </h5>
                        
                                <!-- Dropdown Button -->
                                <div class="relative inline-block mt-2">
                                    {% if unique_cities %}
                                        <span id="dropdownButtonCities" class="material-symbols-outlined bg-[#3E3E3E] text-[#f2f2f2] rounded-xl gap-4 px-5 py-1 cursor-pointer flex items-center justify-between">
                                            <span id="dropdownSelectedValueCities" class="text-sm font-sans font-medium mb-0.5">Select a City</span>
                                            <span class="material-symbols-outlined">arrow_drop_down</span>
                                        </span>
                        
                                        <!-- Dropdown Menu -->
                                        <div id="dropdownMenuCities" class="absolute bg-[#3E3E3E] text-[#f2f2f2] rounded-lg mt-2 p-2 hidden z-10">
                                            {% for city in unique_cities %}
                                                <div class="cursor-pointer p-2 hover:bg-[#555]" data-value="{{ city }}">{{ city.title() }}</div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-500 text-sm">No Cities Available</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
    
    
                        <!-- Monitored Diseases -->
                        <div class="rounded-lg w-full md:w-1/2 h-auto flex-1 text-center p-4 relative bg-gradient-to-bl from-[rgba(102,178,102,0.3)] from-0% to-[rgba(62,62,62,0.3)] to-65%">
                            <span class="material-symbols-outlined bg-[#252525] rounded-full text-lg size-8 absolute top-2 left-2 p-0.5">coronavirus</span>
                            <div class="mt-10 flex flex-col">
                                <h2 class="font-semibold text-sm md:text-base">Monitored Diseases</h2>
                                <div class="ml-12">
                                    <div class="flex items-center gap-4 mt-4">
                                        <img src="{{ url_for('static', filename='images/mosquito.png') }}" class="bg-[#ebe5e5] rounded-full w-9 h-9 p-1 object-contain" alt="Mosquito">
                                        <h2 class="text-sm font-normal">Dengue</h2>
                                    </div>
                                    <div class="flex items-center gap-4 mt-4">
                                        <img src="{{ url_for('static', filename='images/typhoid.png') }}" class="bg-[#ebe5e5] rounded-full w-9 h-9 p-1 object-contain" alt="Mosquito">
                                        <h2 class="text-sm font-normal">Typhoid Fever</h2>
                                    </div>
                                    <div class="flex items-center gap-4 mt-4">
                                        <img src="{{ url_for('static', filename='images/mouse.png') }}" class="bg-[#ebe5e5] rounded-full w-9 h-9 p-1 object-contain" alt="Mosquito">
                                        <h2 class="text-sm font-normal">Leptospirosis</h2>
                                    </div>
                                    <div class="flex items-center gap-4 mt-4">
                                        <img src="{{ url_for('static', filename='images/abd.png') }}" class="bg-[#ebe5e5] rounded-full w-9 h-9 p-1 object-contain" alt="Mosquito">
                                        <h2 class="text-sm font-normal">AB Diarrhea</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Historical Disease Risk Section -->
                <div class="bg-[#252525] h-auto w-full md:w-2/5 relative rounded-2xl text-[#f2f2f2] px-6 py-4 mt-6">
                    <div class="flex flex-col">
                        <h2 class="font-semibold text-lg mb-4">Historical Disease Risk of Each City</h2>
                        
                        <!-- Scrollable Table Container -->
                        <div class="overflow-y-auto max-h-72">
                            <table class="w-full border-separate border-spacing-y-0.5">
                                <thead>
                                    <tr class="text-left text-sm font-bold">
                                        <th class="w-1/12">No.</th>
                                        <th class="w-3/12">City</th>
                                        <th class="w-4/12">Disease</th>
                                        <th class="w-4/12">Risk Level</th>
                                    </tr>
                                </thead>
                                <tbody class="text-sm font-medium">
                                    {% for row in disease_data %}
                                    <tr class="bg-[#3E3E3E] rounded-lg">
                                        <td class="py-2 px-3">{{ loop.index }}</td>
                                        <td class="py-2 px-3">{{ row['City'] }}</td>
                                        <td class="py-2 px-3">{{ row['Disease'] }}</td>
                                        <td class="py-2 px-3 {{ 
                                            'text-[#28A745]' if row['Risk_Level'] == 'Low' else
                                            'text-[#FFC107]' if row['Risk_Level'] == 'Medium' else
                                            'text-[#FD7E14]' if row['Risk_Level'] == 'High' else
                                            'text-[#DC3545]' if row['Risk_Level'] == 'Severe' else ''
                                        }}">
                                            {{ row['Risk_Level'] }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
    
            </div>
            </div>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        const climateImpactData = {{ climate_impact|safe }};
    </script>
    <script>
        // Handle dropdown logic only if data is available
        // Dropdown interaction logic
        {% if unique_cities and city_totals %}
        document.addEventListener('DOMContentLoaded', () => {
            const dropdownButtonCities = document.getElementById('dropdownButtonCities');
            const dropdownMenuCities = document.getElementById('dropdownMenuCities');
            const dropdownSelectedValueCities = document.getElementById('dropdownSelectedValueCities');
            const selectedCitySpan = document.getElementById('selectedCity');
            const totalCasesSpan = document.getElementById('totalCases');

            // Parse city totals from template (fix JSON string issue)
            const cityTotals = {{ city_totals | safe }};
            console.log("Parsed City Totals (direct):", cityTotals);
            console.log("City Totals Object (from template):", cityTotals);
            console.log("Keys in City Totals:", Object.keys(cityTotals));
            // Toggle dropdown menu visibility
            dropdownButtonCities?.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenuCities?.classList.toggle('hidden');
            });

            // Handle selection of a city from the dropdown
            dropdownMenuCities?.addEventListener('click', (e) => {
                e.stopPropagation();
                const target = e.target.closest('[data-value]');
                if (target) {
                    const selectedCity = target.getAttribute('data-value');
                    console.log("Raw data-value:", selectedCity);
                    const cityLower = selectedCity.toLowerCase();
                    console.log("Selected City (lowercase):", cityLower);
                    if (cityTotals[cityLower] !== undefined) {
                        const totalCases = cityTotals[cityLower];
                        console.log("Total Cases:", totalCases);
                        dropdownSelectedValueCities.innerText = target.innerText.trim();
                        selectedCitySpan.innerText = target.innerText.trim();
                        totalCasesSpan.innerText = totalCases || 0;
                    } else {
                        console.warn(`City '${cityLower}' not found in cityTotals.`);
                    }
                }
                dropdownMenuCities.classList.add('hidden');
            });            

            // Hide dropdown menu when clicking outside
            document.addEventListener('click', () => {
                dropdownMenuCities?.classList.add('hidden');
            });
        });
        {% endif %}
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Default data for an empty chart
            let labels = [];
            let data = [];
        
            // Parse the backend data
            let topCitiesAllWeeks = {};
            let weeklyTotals = {};
        
            // Check if the data exists before assigning
            {% if top_4_cities %}
                topCitiesAllWeeks = {{ top_4_cities|tojson }};
            {% endif %}
        
            {% if weekly_totals %}
                weeklyTotals = {{ weekly_totals|tojson }};
            {% endif %}
        
            // Function to update the chart
            const updateChart = (week) => {
                if (week === "all") {
                    // Use top 4 cities for all weeks
                    labels = Object.keys(topCitiesAllWeeks).map(city => city.charAt(0).toUpperCase() + city.slice(1)); // Capitalize city names
                    data = Object.values(topCitiesAllWeeks);
                } else {
                    // Match backend keys like "Week 1", "Week 2", etc.
                    const weekKey = `Week ${week}`;
                    
                    if (weeklyTotals[weekKey]) {
                        // Filter for the selected week
                        const weeklyData = Object.entries(weeklyTotals[weekKey])
                            .sort(([, casesA], [, casesB]) => casesB - casesA) // Sort descending by cases
                            .slice(0, 4); // Get top 4 cities
                        
                        labels = weeklyData.map(([city]) => city.charAt(0).toUpperCase() + city.slice(1)); // Capitalize city names
                        data = weeklyData.map(([, cases]) => cases);
                    } else {
                        // Default to empty data if the week has no data
                        labels = [];
                        data = [];
                    }
                }
        
                // Update the chart with new data
                barChart.data.labels = labels;
                barChart.data.datasets[0].data = data;
                barChart.update();
            };
        
            // Define the gradient colors for each bar
            const barColors = [
                ['189, 189, 189', '255, 102, 102'], // Gradient for the first bar
                ['189, 189, 189', '102, 178, 102'], // Gradient for the second bar
                ['189, 189, 189', '102, 102, 255'], // Gradient for the third bar
                ['189, 189, 189', '255, 193, 7'],   // Gradient for the fourth bar
            ];
        
            // Function to create gradients for bars
            function getGradient(ctx, chartArea, colors) {
                const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                gradient.addColorStop(0, `rgba(${colors[0]}, 1)`);
                gradient.addColorStop(1, `rgba(${colors[1]}, 1)`);
                return gradient;
            }
        
            // Initialize the chart
            const barCtx = document.getElementById('barChart').getContext('2d');
            const barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cases',
                        data: data,
                        backgroundColor: function (context) {
                            const { chart, dataIndex } = context;
                            const { ctx, chartArea } = chart;
        
                            if (!chartArea) {
                                return; // Wait until chartArea is available
                            }
        
                            // Pass specific colors for the gradient based on index
                            return getGradient(ctx, chartArea, barColors[dataIndex] || ['189, 189, 189', '255, 255, 255']);
                        },
                        borderWidth: 1,
                        borderRadius: 15,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#F2F2F2', // X-axis label color
                            },
                            grid: {
                                display: false // Hide grid lines on the X-axis
                            }
                        },
                        y: {
                            ticks: {
                                color: '#F2F2F2', // Y-axis label color
                            },
                            grid: {
                                display: true // Show grid lines on the Y-axis
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'valueOnTop',
                    afterDatasetsDraw: (chart) => {
                        const { ctx } = chart;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                const { x, y } = bar.tooltipPosition();
        
                                ctx.fillStyle = '#f2f2f2'; // Text color
                                ctx.font = 'bold 12px Montserrat'; // Font style
                                ctx.textAlign = 'center';
                                ctx.fillText(value, x, y - 10); // Positioning the text above the bar
                            });
                        });
                    }
                }]
            });
        
            // Dropdown interaction
            const dropdownMenu = document.getElementById('dropdownMenuWeeks');
            const dropdownButton = document.getElementById('dropdownButtonWeeks');
            const dropdownSelectedValue = document.getElementById('dropdownSelectedValueWeeks');
        
            dropdownMenu.querySelectorAll('div[data-value]').forEach(item => {
                item.addEventListener('click', () => {
                    const selectedValue = item.getAttribute('data-value');
                    dropdownSelectedValue.textContent = selectedValue === "all" ? "All Weeks" : `Week ${selectedValue}`;
                    updateChart(selectedValue); // Update the chart based on the selection
                    dropdownMenu.classList.add('hidden'); // Hide the dropdown menu
                });
            });
        
            // Toggle dropdown visibility
            dropdownButton.addEventListener('click', () => {
                dropdownMenu.classList.toggle('hidden');
            });
        
            // Initialize the chart with "All Weeks" data
            updateChart("all");
        });
        
    </script>
    
    
</body>
</html>
